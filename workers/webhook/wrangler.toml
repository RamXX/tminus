# ============================================================================
# tminus-webhook -- Google Calendar push notification receiver
# Receives webhook callbacks and enqueues sync messages.
# ============================================================================

name = "tminus-webhook"
main = "src/index.ts"
compatibility_date = "2025-02-14"
compatibility_flags = ["nodejs_compat"]

# --- D1 registry database --------------------------------------------------

[[d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

# --- Queue producers -------------------------------------------------------

[[queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue"

[vars]
ENVIRONMENT = "development"

# --- Secrets (set via `wrangler secret put`, listed here for documentation) -
# MS_WEBHOOK_CLIENT_STATE -- shared secret for validating Microsoft Graph
#                            change notifications (clientState field).
#                            Not needed until Microsoft provider support is live.
#
# NOTE: This worker does NOT need MASTER_KEY or JWT_SECRET. Google webhook
# validation uses D1 channel_token lookup (shared secret set during watch
# registration). See TM-pd65 for the architectural audit.

# ===========================================================================
# Staging environment: tminus-webhook-staging
# Deploy with: wrangler deploy --env staging
# ===========================================================================

[env.staging]
name = "tminus-webhook-staging"

[env.staging.vars]
ENVIRONMENT = "staging"

[[env.staging.routes]]
pattern = "webhooks-staging.tminus.ink/*"
zone_name = "tminus.ink"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "tminus-registry-staging"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.staging.queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue-staging"

# ===========================================================================
# Production environment: tminus-webhook-production
# Deploy with: wrangler deploy --env production
# ===========================================================================

[env.production]
name = "tminus-webhook-production"

[env.production.vars]
ENVIRONMENT = "production"

[[env.production.routes]]
pattern = "webhooks.tminus.ink/*"
zone_name = "tminus.ink"

[[env.production.d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.production.queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue"
