# ============================================================================
# tminus-sync-consumer -- Processes sync queue messages
# Consumes from sync-queue, produces to write-queue and sync-queue (410 retry).
# Extended CPU limit for large batch processing.
# ============================================================================

name = "tminus-sync-consumer"
main = "src/index.ts"
compatibility_date = "2025-02-14"
compatibility_flags = ["nodejs_compat"]

# --- CPU limits (extended for large batch processing) -----------------------

[limits]
cpu_ms = 300000

# --- Durable Object references (hosted on tminus-api) ----------------------

[[durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api"

[[durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api"

# --- D1 registry database --------------------------------------------------

[[d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

# --- Queue producers -------------------------------------------------------

[[queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue"

[[queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue"

# --- Queue consumers --------------------------------------------------------

[[queues.consumers]]
queue = "tminus-sync-queue"
max_batch_size = 5
max_batch_timeout = 5
max_retries = 5
dead_letter_queue = "tminus-sync-queue-dlq"

[[queues.consumers]]
queue = "tminus-reconcile-queue"
max_batch_size = 5
max_batch_timeout = 10
max_retries = 3
dead_letter_queue = "tminus-reconcile-queue-dlq"

[vars]
ENVIRONMENT = "development"
DELETE_GUARD_ENABLED = "true"
DELETE_GUARD_MAX_DELETES_PER_SYNC_RUN = "25"
DELETE_GUARD_MAX_DELETES_PER_ACCOUNT_BATCH = "50"
DELETE_GUARD_MAX_DELETES_PER_BATCH = "100"

# --- Secrets -------------------------------------------------------------------
# This worker does NOT need direct secrets. All credential operations are
# delegated to AccountDO via DO RPC (hosted on tminus-api where secrets exist).
# See TM-pd65 for the architectural audit confirming this design.

# ===========================================================================
# Staging environment: tminus-sync-consumer-staging
# Deploy with: wrangler deploy --env staging
# ===========================================================================

[env.staging]
name = "tminus-sync-consumer-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
DELETE_GUARD_ENABLED = "true"
DELETE_GUARD_MAX_DELETES_PER_SYNC_RUN = "25"
DELETE_GUARD_MAX_DELETES_PER_ACCOUNT_BATCH = "50"
DELETE_GUARD_MAX_DELETES_PER_BATCH = "100"

[env.staging.limits]
cpu_ms = 300000

[[env.staging.d1_databases]]
binding = "DB"
database_name = "tminus-registry-staging"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.staging.durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api-staging"

[[env.staging.durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api-staging"

[[env.staging.queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue-staging"

[[env.staging.queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue-staging"

[[env.staging.queues.consumers]]
queue = "tminus-sync-queue-staging"
max_batch_size = 5
max_batch_timeout = 5
max_retries = 5
dead_letter_queue = "tminus-sync-queue-staging-dlq"

[[env.staging.queues.consumers]]
queue = "tminus-reconcile-queue-staging"
max_batch_size = 5
max_batch_timeout = 10
max_retries = 3
dead_letter_queue = "tminus-reconcile-queue-staging-dlq"

# ===========================================================================
# Production environment: tminus-sync-consumer-production
# Deploy with: wrangler deploy --env production
# ===========================================================================

[env.production]
name = "tminus-sync-consumer-production"

[env.production.vars]
ENVIRONMENT = "production"
DELETE_GUARD_ENABLED = "true"
DELETE_GUARD_MAX_DELETES_PER_SYNC_RUN = "25"
DELETE_GUARD_MAX_DELETES_PER_ACCOUNT_BATCH = "50"
DELETE_GUARD_MAX_DELETES_PER_BATCH = "100"

[env.production.limits]
cpu_ms = 300000

[[env.production.d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.production.durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api-production"

[[env.production.durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api-production"

[[env.production.queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue"

[[env.production.queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue"

[[env.production.queues.consumers]]
queue = "tminus-sync-queue"
max_batch_size = 5
max_batch_timeout = 5
max_retries = 5
dead_letter_queue = "tminus-sync-queue-dlq"

[[env.production.queues.consumers]]
queue = "tminus-reconcile-queue"
max_batch_size = 5
max_batch_timeout = 10
max_retries = 3
dead_letter_queue = "tminus-reconcile-queue-dlq"
