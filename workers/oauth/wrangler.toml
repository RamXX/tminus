# ============================================================================
# tminus-oauth -- OAuth callback and token exchange worker
# Hosts OnboardingWorkflow class definition.
# References UserGraphDO and AccountDO from tminus-api.
# ============================================================================

name = "tminus-oauth"
main = "src/index.ts"
compatibility_date = "2025-02-14"
compatibility_flags = ["nodejs_compat"]

# --- Durable Object references (hosted on tminus-api) ----------------------

[[durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api"

[[durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api"

# --- D1 registry database --------------------------------------------------

[[d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

# --- Workflow definitions (hosted here) ------------------------------------

[[workflows]]
binding = "ONBOARDING_WORKFLOW"
name = "onboarding-workflow"
class_name = "OnboardingWorkflow"

# --- Queue producers (needed by OnboardingWorkflow) --------------------------

[[queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue"

[vars]
ENVIRONMENT = "development"
WEBHOOK_URL = "https://webhooks.tminus.ink/webhook/google"

# --- Secrets (set via `wrangler secret put`, listed here for documentation) -
# GOOGLE_CLIENT_ID
# GOOGLE_CLIENT_SECRET
# MS_CLIENT_ID        -- Microsoft Entra ID (Azure AD) client ID
# MS_CLIENT_SECRET    -- Microsoft Entra ID (Azure AD) client secret
# MASTER_KEY          -- envelope encryption master key
# JWT_SECRET          -- API auth JWT signing secret

# ===========================================================================
# Staging environment: tminus-oauth-staging
# Deploy with: wrangler deploy --env staging
# ===========================================================================

[env.staging]
name = "tminus-oauth-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
WEBHOOK_URL = "https://webhooks-staging.tminus.ink/webhook/google"

[[env.staging.queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue-staging"

[[env.staging.routes]]
pattern = "oauth-staging.tminus.ink/*"
zone_name = "tminus.ink"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "tminus-registry-staging"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.staging.durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api-staging"

[[env.staging.durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api-staging"

[[env.staging.workflows]]
binding = "ONBOARDING_WORKFLOW"
name = "onboarding-workflow-staging"
class_name = "OnboardingWorkflow"

# ===========================================================================
# Production environment: tminus-oauth-production
# Deploy with: wrangler deploy --env production
# ===========================================================================

[env.production]
name = "tminus-oauth-production"

[env.production.vars]
ENVIRONMENT = "production"
WEBHOOK_URL = "https://webhooks.tminus.ink/webhook/google"

[[env.production.queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue"

[[env.production.routes]]
pattern = "oauth.tminus.ink/*"
zone_name = "tminus.ink"

[[env.production.d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.production.durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api-production"

[[env.production.durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api-production"

[[env.production.workflows]]
binding = "ONBOARDING_WORKFLOW"
name = "onboarding-workflow"
class_name = "OnboardingWorkflow"
