# ============================================================================
# tminus-cron -- Scheduled maintenance worker
# Handles channel renewal, token health checks, and drift reconciliation.
# Hosts ReconcileWorkflow class definition.
# ============================================================================

name = "tminus-cron"
main = "src/index.ts"
compatibility_date = "2025-02-14"
compatibility_flags = ["nodejs_compat"]

# --- Cron triggers ----------------------------------------------------------

[triggers]
crons = [
  "0 */6 * * *",   # Channel renewal: every 6 hours
  "0 */12 * * *",  # Token health check: every 12 hours
  "0 3 * * *",     # Drift reconciliation: daily at 03:00 UTC
  "0 4 * * *",     # Social drift computation: daily at 04:00 UTC
  "*/15 * * * *",  # ICS feed refresh: every 15 minutes
]

# --- Durable Object references (hosted on tminus-api) ----------------------

[[durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api"

[[durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api"

# --- D1 registry database --------------------------------------------------

[[d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

# --- Queue producers -------------------------------------------------------

[[queues.producers]]
binding = "RECONCILE_QUEUE"
queue = "tminus-reconcile-queue"

[[queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue"

[[queues.producers]]
binding = "PUSH_QUEUE"
queue = "tminus-push-queue"

# --- Workflow definitions (hosted here) ------------------------------------

[[workflows]]
binding = "RECONCILE_WORKFLOW"
name = "reconcile-workflow"
class_name = "ReconcileWorkflow"

[vars]
ENVIRONMENT = "development"
WEBHOOK_URL = "https://webhooks.tminus.ink/webhook/google"

# --- Secrets (set via `wrangler secret put`, listed here for documentation) -
# MASTER_KEY          -- envelope encryption master key

# ===========================================================================
# Staging environment: tminus-cron-staging
# Deploy with: wrangler deploy --env staging
# ===========================================================================

[env.staging]
name = "tminus-cron-staging"

[env.staging.vars]
ENVIRONMENT = "staging"
WEBHOOK_URL = "https://webhooks-staging.tminus.ink/webhook/google"

[env.staging.triggers]
crons = [
  "0 */6 * * *",   # Channel renewal: every 6 hours
  "0 */12 * * *",  # Token health check: every 12 hours
  "0 3 * * *",     # Drift reconciliation: daily at 03:00 UTC
  "0 4 * * *",     # Social drift computation: daily at 04:00 UTC
  "*/15 * * * *",  # ICS feed refresh: every 15 minutes
]

[[env.staging.d1_databases]]
binding = "DB"
database_name = "tminus-registry-staging"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.staging.durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api-staging"

[[env.staging.durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api-staging"

[[env.staging.queues.producers]]
binding = "RECONCILE_QUEUE"
queue = "tminus-reconcile-queue-staging"

[[env.staging.queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue-staging"

[[env.staging.queues.producers]]
binding = "PUSH_QUEUE"
queue = "tminus-push-queue-staging"

[[env.staging.workflows]]
binding = "RECONCILE_WORKFLOW"
name = "reconcile-workflow-staging"
class_name = "ReconcileWorkflow"

# ===========================================================================
# Production environment: tminus-cron-production
# Deploy with: wrangler deploy --env production
# ===========================================================================

[env.production]
name = "tminus-cron-production"

[env.production.vars]
ENVIRONMENT = "production"
WEBHOOK_URL = "https://webhooks.tminus.ink/webhook/google"

[env.production.triggers]
crons = [
  "0 */6 * * *",   # Channel renewal: every 6 hours
  "0 */12 * * *",  # Token health check: every 12 hours
  "0 3 * * *",     # Drift reconciliation: daily at 03:00 UTC
  "0 4 * * *",     # Social drift computation: daily at 04:00 UTC
  "*/15 * * * *",  # ICS feed refresh: every 15 minutes
]

[[env.production.d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.production.durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"
script_name = "tminus-api-production"

[[env.production.durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"
script_name = "tminus-api-production"

[[env.production.queues.producers]]
binding = "RECONCILE_QUEUE"
queue = "tminus-reconcile-queue"

[[env.production.queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue"

[[env.production.queues.producers]]
binding = "PUSH_QUEUE"
queue = "tminus-push-queue"

[[env.production.workflows]]
binding = "RECONCILE_WORKFLOW"
name = "reconcile-workflow"
class_name = "ReconcileWorkflow"
