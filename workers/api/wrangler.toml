# ============================================================================
# tminus-api -- Main API worker
# Hosts UserGraphDO and AccountDO class definitions.
# Other workers reference these DOs via script_name = "tminus-api".
# ============================================================================

name = "tminus-api"
main = "src/dev-entry.ts"
compatibility_date = "2025-02-14"
compatibility_flags = ["nodejs_compat"]

[vars]
ENVIRONMENT = "development"

# --- Durable Object class definitions (hosted here) -----------------------

[[durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"

[[durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"

# DO migrations -- SQLite storage for both DOs
[[migrations]]
tag = "v1"
new_sqlite_classes = ["UserGraphDO", "AccountDO"]

# --- D1 registry database --------------------------------------------------

[[d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

# --- Queue producers -------------------------------------------------------

[[queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue"

[[queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue"

[[queues.producers]]
binding = "PUSH_QUEUE"
queue = "tminus-push-queue"

# --- KV namespaces -----------------------------------------------------------

[[kv_namespaces]]
binding = "SESSIONS"
id = "8641f58e6fc24539b6a1e2bcf26afd44"

[[kv_namespaces]]
binding = "RATE_LIMITS"
id = "fff8534aadf848a8a9a9fcac07828bdf"

# --- Workers AI ---------------------------------------------------------------

[ai]
binding = "AI"

# --- R2 buckets ---------------------------------------------------------------

[[r2_buckets]]
binding = "PROOF_BUCKET"
bucket_name = "tminus-proof-exports"

# --- Secrets (set via `wrangler secret put`, listed here for documentation) -
# JWT_SECRET          -- API auth JWT signing secret
# MASTER_KEY          -- envelope encryption master key (DEK wrapping in AccountDO)
# GOOGLE_CLIENT_ID    -- Google OAuth client ID (AccountDO token refresh)
# GOOGLE_CLIENT_SECRET-- Google OAuth client secret (AccountDO token refresh)
# MS_CLIENT_ID        -- Microsoft Entra ID client ID (AccountDO token refresh)
# MS_CLIENT_SECRET    -- Microsoft Entra ID client secret (AccountDO token refresh)

# ===========================================================================
# Staging environment: tminus-api-staging
# Deploy with: wrangler deploy --env staging
# ===========================================================================

[env.staging]
name = "tminus-api-staging"

[env.staging.vars]
ENVIRONMENT = "staging"

[[env.staging.routes]]
pattern = "api-staging.tminus.ink/*"
zone_name = "tminus.ink"

# DO class definitions (no inheritance from top-level)
[[env.staging.durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"

[[env.staging.durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"

[[env.staging.migrations]]
tag = "v1"
new_sqlite_classes = ["UserGraphDO", "AccountDO"]

[[env.staging.d1_databases]]
binding = "DB"
database_name = "tminus-registry-staging"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.staging.kv_namespaces]]
binding = "SESSIONS"
id = "8641f58e6fc24539b6a1e2bcf26afd44"

[[env.staging.kv_namespaces]]
binding = "RATE_LIMITS"
id = "fff8534aadf848a8a9a9fcac07828bdf"

[[env.staging.queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue-staging"

[[env.staging.queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue-staging"

[[env.staging.queues.producers]]
binding = "PUSH_QUEUE"
queue = "tminus-push-queue-staging"

[[env.staging.r2_buckets]]
binding = "PROOF_BUCKET"
bucket_name = "tminus-proof-exports-staging"

[env.staging.ai]
binding = "AI"

# ===========================================================================
# Production environment: tminus-api-production
# Deploy with: wrangler deploy --env production
# ===========================================================================

[env.production]
name = "tminus-api-production"

[env.production.vars]
ENVIRONMENT = "production"

[[env.production.routes]]
pattern = "api.tminus.ink/*"
zone_name = "tminus.ink"

# DO class definitions (no inheritance from top-level)
[[env.production.durable_objects.bindings]]
name = "USER_GRAPH"
class_name = "UserGraphDO"

[[env.production.durable_objects.bindings]]
name = "ACCOUNT"
class_name = "AccountDO"

[[env.production.migrations]]
tag = "v1"
new_sqlite_classes = ["UserGraphDO", "AccountDO"]

[[env.production.d1_databases]]
binding = "DB"
database_name = "tminus-registry"
database_id = "7a72bc74-0558-450f-b193-f7acd19c6c9c"

[[env.production.kv_namespaces]]
binding = "SESSIONS"
id = "8641f58e6fc24539b6a1e2bcf26afd44"

[[env.production.kv_namespaces]]
binding = "RATE_LIMITS"
id = "fff8534aadf848a8a9a9fcac07828bdf"

[[env.production.queues.producers]]
binding = "SYNC_QUEUE"
queue = "tminus-sync-queue"

[[env.production.queues.producers]]
binding = "WRITE_QUEUE"
queue = "tminus-write-queue"

[[env.production.queues.producers]]
binding = "PUSH_QUEUE"
queue = "tminus-push-queue"

[[env.production.r2_buckets]]
binding = "PROOF_BUCKET"
bucket_name = "tminus-proof-exports"

[env.production.ai]
binding = "AI"
